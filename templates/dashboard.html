{% extends 'base.html' %}
{% block title %}Dashboard Â· Emotion Classifier{% endblock %}
{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
  <h1>Dashboard</h1>
  <p>Welcome back! Here's your emotion analysis overview.</p>
</div>

<div class="row g-4">
  <!-- Chart Section -->
  <div class="col-lg-8">
    <div class="card p-4 h-100">
      <h5 class="mb-4"><i data-lucide="bar-chart-3" class="icon-inline"></i> Emotion Distribution</h5>
      <canvas id="distChart" height="180"></canvas>
    </div>
  </div>

  <!-- Stats & Actions -->
  <div class="col-lg-4">
    <!-- Stats Card -->
    <div class="card p-4 mb-4">
      <h5 class="mb-3"><i data-lucide="trending-up" class="icon-inline"></i> Statistics</h5>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="stat-value">{{ total_count }}</div>
          <div class="stat-label">Total Predictions</div>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <span class="modality-icon modality-multimodal"><i data-lucide="star"></i></span>
        <div>
          <div style="font-weight: 600;">{{ most_common or 'N/A' }}</div>
          <div class="stat-label">Most Common</div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card p-4">
      <h5 class="mb-3"><i data-lucide="zap" class="icon-inline"></i> Quick Actions</h5>
      <a href="{{ url_for('predict_speech') }}" class="btn btn-speech btn-custom w-100 mb-2 text-white">
        <i data-lucide="mic" class="icon-inline"></i> Speech Analysis
      </a>
      <a href="{{ url_for('predict_text') }}" class="btn btn-text btn-custom w-100 mb-2 text-white">
        <i data-lucide="file-text" class="icon-inline"></i> Text Analysis
      </a>
      <a href="{{ url_for('predict_image') }}" class="btn btn-image btn-custom w-100 mb-2 text-white">
        <i data-lucide="camera" class="icon-inline"></i> Image Analysis
      </a>
      <a href="{{ url_for('predict_multimodal') }}" class="btn btn-multimodal btn-custom w-100 text-white">
        <i data-lucide="layers" class="icon-inline"></i> Multimodal Fusion
      </a>
    </div>
  </div>
</div>

<!-- Recent Predictions -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i data-lucide="clock" class="icon-inline"></i> Recent Predictions</h5>
        <a href="{{ url_for('history') }}" class="btn btn-secondary btn-sm">View All</a>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Modality</th>
              <th>Emotion</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody>
            {% for p in recent %}
            <tr>
              <td>{{ p.prediction_date.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <span class="modality-icon modality-{{ p.input_type }}">
                  {% if p.input_type == 'speech' %}<i data-lucide="mic"></i>{% elif p.input_type == 'text' %}<i
                    data-lucide="file-text"></i>{% elif p.input_type == 'image' %}<i data-lucide="camera"></i>{% else
                  %}<i data-lucide="layers"></i>{% endif %}
                </span>
                {{ p.input_type|capitalize }}
              </td>
              <td>
                <span class="emotion-badge emotion-{{ p.predicted_emotion }}">
                  {{ p.predicted_emotion }}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="confidence-bar" style="width: 100px; margin-right: 8px;">
                    <div class="confidence-fill" style="width: {{ (p.confidence_score or 0) * 100 }}%;"></div>
                  </div>
                  <span>{{ '%.0f'|format((p.confidence_score or 0) * 100) }}%</span>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="text-center py-4" style="color: var(--text-secondary);">
                No predictions yet. Start by analyzing some content!
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const labels = {{ chart_labels| tojson }};
  const values = {{ chart_values| tojson }};
  const ctx = document.getElementById('distChart');

  if (ctx) {
    Chart.defaults.color = '#a0a0b0';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.08)';

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Count',
          data: values,
          backgroundColor: [
            'rgba(34, 197, 94, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(239, 68, 68, 0.8)',
            'rgba(168, 85, 247, 0.8)',
            'rgba(236, 72, 153, 0.8)',
            'rgba(249, 115, 22, 0.8)',
            'rgba(107, 114, 128, 0.8)'
          ],
          borderRadius: 8,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { precision: 0 }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
  }

  // Re-init Lucide icons for dynamic content
  lucide.createIcons();
</script>
{% endblock %}